{
  "name": "CLINICA CONSOLE - TEMPLATE",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -4144,
        2176
      ],
      "id": "6e4da969-ed16-4891-b4d5-b5296e6f04b8",
      "name": "inputTest",
      "webhookId": "8b8fc783-f576-4ac7-9e83-8942f7b1a3a3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "94127c6c-e9ab-4ead-a5ab-e3fbebf4fc71",
              "name": "query",
              "value": "={{ $json.chatInput }}",
              "type": "string"
            },
            {
              "id": "0b8a8ff0-1ff9-45ba-9c4e-27bb639f6f37",
              "name": "identifier",
              "value": "=test-n8n:{{ $json.sessionId }}",
              "type": "string"
            },
            {
              "id": "08017764-9c23-48fe-a8a6-1f863606f0eb",
              "name": "telefone",
              "value": "telefone de teste aqui",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3856,
        2176
      ],
      "id": "47141df6-12ed-4d46-a881-fee7992b71b4",
      "name": "trataDados"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "query"
            },
            {
              "name": "identifier"
            },
            {
              "name": "telefone"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -3824,
        2480
      ],
      "id": "5317d2a1-3530-4134-9b4e-fcad572d9ee6",
      "name": "recebeDadosExternos"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -3488,
        2192
      ],
      "id": "c91961e6-7575-4859-88cf-73aff748aa6f",
      "name": "agrupaDados"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {
          "temperature": 0.7
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -2960,
        2496
      ],
      "id": "17b06978-a617-4e2b-88a3-4f9a78c552a3",
      "name": "openai4.1Mini",
      "credentials": {
        "openAiApi": {
          "id": "DmoP52AOXhbHyxyX",
          "name": "Lena AI OpenAi"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.query }}",
        "options": {
          "systemMessage": "# AGENTE ROTEADOR - MedCenter Lena AI\n\n## Identidade\n- **Nome:** Roteador Principal de Atendimento\n- **FunÃ§Ã£o:** Agente de AnÃ¡lise e Redirecionamento de Pacientes\n- **Empresa:** ClÃ­nica Lena AI\n\n## Personalidade\n- AnalÃ­tico, Eficiente, Preciso, InvisÃ­vel.\n\n## Objetivo Principal\nAnalisar a intenÃ§Ã£o da mensagem do paciente e acionar o agente especialista mais adequado.\n\n## Regras de Roteamento\n- **Se a intenÃ§Ã£o for agendar, reagendar, cancelar ou perguntar sobre horÃ¡rios:** Acione o `agente_agendador`.\n- **Se a intenÃ§Ã£o for tirar dÃºvidas gerais sobre a clÃ­nica (convÃªnios, localizaÃ§Ã£o, etc.):** Acione o `agente_faq`.\n- **Para TODO o resto (primeiro contato, saudaÃ§Ã£o, perguntas sobre tratamentos, descriÃ§Ã£o de problemas):** Acione o `agente_atende_qualifica`. Ele Ã© o responsÃ¡vel por iniciar a conversa e, se necessÃ¡rio, mostrar as mÃ­dias dos procedimentos.\n- **Se a pergunta for detalhada e tÃ©cnica sobre um procedimento:** Acione `agente_especialista_procedimentos`.\n\n## Ferramentas (Subagentes) DisponÃ­veis\n- **`agente_atende_qualifica`**: Para o primeiro contato, qualificaÃ§Ã£o do paciente, entendimento das dores e apresentaÃ§Ã£o visual dos tratamentos, preÃ§os. **Este Ã© o agente principal para iniciar 90% das conversas.**\n- **`agente_agendador`**: Especialista em gerenciar a agenda (marcar, remarcar, cancelar, consultar horÃ¡rios).\n- **`agente_faq`**: Especialista em responder perguntas frequentes (FAQ) sobre a clÃ­nica.\n- **`agente_especialista_procedimentos`**: Acione quando o paciente fizer uma pergunta especÃ­fica ou detalhada sobre um procedimento, como 'dÃ³i?', 'quanto tempo dura?', 'como Ã© a recuperaÃ§Ã£o?'. Use para aprofundar em um tÃ³pico, nÃ£o para o primeiro contato.\n\n## Regra de SaÃ­da Final (CRÃTICA E OBRIGATÃ“RIA)\nSua Ãºnica saÃ­da deve ser a resposta **EXATA** fornecida pelo subagente acionado. NÃ£o resuma, nÃ£o refraseie, nÃ£o adicione nada."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        -2960,
        2192
      ],
      "id": "6f4c0fbf-6bed-48e2-9d5c-62c4526b09ed",
      "name": "agente_roteador"
    },
    {
      "parameters": {
        "content": " ```\nâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—\nâ–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘\nâ–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘\nâ–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘\nâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘\nâ•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•    â•šâ•â•  â•šâ•â•â•šâ•â•\n ```                                            ",
        "width": 500,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1488,
        560
      ],
      "typeVersion": 1,
      "id": "884cd269-e71e-4b6b-a65e-bdd68a376811",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 192,
        "width": 292,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4240,
        2160
      ],
      "typeVersion": 1,
      "id": "4adac1b2-2b35-4bf5-85db-160dc5a2aaf8",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Calendar', `Insira aqui o id_agenda exato do profissional, que vocÃª identificou ao consultar o Mapeamento de Agendas e TÃ³picos no seu prompt. Este valor deve ser um id, como por exemplo 'bb4417b38dff3bb5b9d739abdf2faa2d4f9330379912b91b776c494164507cc9@group.calendar.google.com'.`, 'string') }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        -1888,
        2000
      ],
      "id": "f24f8aee-7072-4064-8da8-1ecdb04db67d",
      "name": "verificar_disponibilidade_agenda",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "1VrcmzO7tnetZSRV",
          "name": "Instituto Philippe Google Calendar"
        }
      }
    },
    {
      "parameters": {
        "content": "#### **inputTest**\n*_(Tipo: Chat Trigger)_*\n**ðŸŽ¯ Objetivo:** Iniciar o fluxo para testes manuais.\n**ðŸ“ Detalhes:**\n* Este Ã© um ponto de entrada para vocÃª testar o chatbot diretamente na interface do n8n, sem precisar conectar a um canal externo como o WhatsApp.\n* Tudo que vocÃª digitar no campo de mensagem deste nÃ³ serÃ¡ enviado como a `query` do usuÃ¡rio para o restante do fluxo.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Nenhuma. Apenas utilize para testes.",
        "height": 340,
        "width": 284,
        "color": 4
      },
      "id": "cf7440fa-9558-463f-8b3b-53a6ded49844",
      "name": "Sticky Note67",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4240,
        1824
      ]
    },
    {
      "parameters": {
        "content": "                                           ",
        "width": 420,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3040,
        2176
      ],
      "typeVersion": 1,
      "id": "73b06bee-3ab6-44d6-b576-f96717ff620f",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 192,
        "width": 292,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3920,
        2160
      ],
      "typeVersion": 1,
      "id": "ab70a791-7e7c-4e9c-848a-eddf8dc9f718",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "#### **trataDados**\n*_(Tipo: Set)_*\n**ðŸŽ¯ Objetivo:** Padronizar os dados de entrada para o sistema.\n**ðŸ“ Detalhes:**\n* Este nÃ³ pega a mensagem do usuÃ¡rio (`chatInput`) e o ID da sessÃ£o (`sessionId`) do `inputTest`.\n* Ele organiza esses dados em um formato JSON limpo, com as chaves `query` e `identifier`, que serÃ£o usadas por todo o workflow para identificar a mensagem e o histÃ³rico da conversa.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Nenhuma. Este nÃ³ jÃ¡ estÃ¡ configurado para funcionar com o `inputTest`.",
        "height": 356,
        "width": 284,
        "color": 4
      },
      "id": "21f449b3-e7d9-416d-8d88-591144cfa87a",
      "name": "Sticky Note68",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3920,
        1808
      ]
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 192,
        "width": 292,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3584,
        2160
      ],
      "typeVersion": 1,
      "id": "aed6cd90-d2d6-48e9-a47a-e1650e6f6189",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "#### **agrupaDados**\n*_(Tipo: Merge)_*\n**ðŸŽ¯ Objetivo:** Unificar os pontos de entrada do fluxo.\n**ðŸ“ Detalhes:**\n* Ele garante que, nÃ£o importa se o fluxo foi iniciado pelo `inputTest` ou pelo `recebeDadosExternos`, os dados sigam em um Ãºnico caminho e formato para o restante do processo.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Nenhuma. Ã‰ um nÃ³ de organizaÃ§Ã£o.",
        "height": 292,
        "width": 284,
        "color": 4
      },
      "id": "c3c902c0-4380-4f00-9dba-31632862d29f",
      "name": "Sticky Note69",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3584,
        1872
      ]
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 384,
        "width": 292,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3888,
        2384
      ],
      "typeVersion": 1,
      "id": "15309604-91f2-4331-bacb-7fe9cc4b019a",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "#### **recebeDadosExternos**\n*_(Tipo: Execute Workflow Trigger)_*\n**ðŸŽ¯ Objetivo:** Permitir que este workflow seja iniciado por outro fluxo.\n**ðŸ“ Detalhes:**\n* Este nÃ³ funciona como um ponto de entrada alternativo. Ã‰ Ãºtil para integraÃ§Ãµes mais complexas, como receber dados de um webhook de WhatsApp que jÃ¡ passou por um tratamento inicial em outro workflow (como a verificaÃ§Ã£o de cliente no Supabase que vocÃª mostrou no print).\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Nenhuma para o funcionamento bÃ¡sico, mas pode ser conectado a outros workflows conforme sua necessidade.\n",
        "height": 388,
        "width": 284,
        "color": 4
      },
      "id": "9d3442fb-860a-414b-9405-df1d7014a386",
      "name": "Sticky Note70",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4176,
        2384
      ]
    },
    {
      "parameters": {
        "content": "",
        "height": 2292,
        "width": 2556,
        "color": 7
      },
      "id": "626ea27b-9a0e-4143-9cf8-c82e70749aad",
      "name": "Sticky Note73",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3072,
        1136
      ]
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 224,
        "width": 340,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1280,
        2176
      ],
      "typeVersion": 1,
      "id": "b5d14471-c886-480f-8170-a9426d7989aa",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 624,
        "width": 708,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2048,
        1728
      ],
      "typeVersion": 1,
      "id": "50e3039f-e69a-4be1-a65e-84ffdff8b2e3",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 384,
        "width": 404,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2544,
        1968
      ],
      "typeVersion": 1,
      "id": "b4bb720e-4cc4-4878-9c1a-b2886f75cb52",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "content": "",
        "height": 1108,
        "width": 1068,
        "color": 7
      },
      "id": "1c7df4d8-41e3-45b7-add5-1664c0b24909",
      "name": "Sticky Note82",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4352,
        1744
      ]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('agrupaDados').first().json.identifier }}",
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -2784,
        2496
      ],
      "id": "e16df0ce-e3e0-45a5-8c59-0fe558de00e2",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "lkXnrfeCDBqgODYW",
          "name": "Postgres Lia Assessora"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from n8n_chat_histories",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2112,
        2000
      ],
      "id": "2d269084-ddbd-4f2c-9542-d709e58c4916",
      "name": "deletaHistoricoChatN8n",
      "credentials": {
        "postgres": {
          "id": "lkXnrfeCDBqgODYW",
          "name": "Postgres Lia Assessora"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from chats",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2352,
        2000
      ],
      "id": "4dbdf739-cb37-4385-ae39-b1344475f7ec",
      "name": "deletaConteudoChats",
      "credentials": {
        "postgres": {
          "id": "lkXnrfeCDBqgODYW",
          "name": "Postgres Lia Assessora"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "delete from chat_messages",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2112,
        2208
      ],
      "id": "898038e5-2d30-4d68-872f-ea6d4547ba00",
      "name": "deletaConteudoChatMessages",
      "credentials": {
        "postgres": {
          "id": "lkXnrfeCDBqgODYW",
          "name": "Postgres Lia Assessora"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE TABLE chat_messages (\n  id BIGSERIAL PRIMARY KEY,\n  created_at TIMESTAMPTZ, \n  phone TEXT,\n  conversation_id TEXT, \n  bot_message TEXT,\n  user_message TEXT, \n  active BOOLEAN DEFAULT TRUE\n);\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2112,
        1552
      ],
      "id": "9a68c4cc-b421-42d8-8016-69fa6c90f6c4",
      "name": "1 - criaTabelaChatMessages",
      "credentials": {
        "postgres": {
          "id": "lkXnrfeCDBqgODYW",
          "name": "Postgres Lia Assessora"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "create table chats (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  phone text,\n  email text,\n  updated_at text,\n  ai_service text,\n  conversation_id text\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2112,
        1760
      ],
      "id": "113dfbc4-5b22-48da-8d66-ab45af6c7e64",
      "name": "2 - criaTabelaChats",
      "credentials": {
        "postgres": {
          "id": "lkXnrfeCDBqgODYW",
          "name": "Postgres Lia Assessora"
        }
      }
    },
    {
      "parameters": {
        "content": "",
        "height": 464,
        "width": 524,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2032,
        1504
      ],
      "typeVersion": 1,
      "id": "49367370-cb00-47d5-bc14-ea2ea5487898",
      "name": "Sticky Note24"
    },
    {
      "parameters": {
        "content": "",
        "height": 400,
        "width": 528,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2032,
        1984
      ],
      "typeVersion": 1,
      "id": "a9e56f6d-c71f-49c6-812f-264fac817f95",
      "name": "Sticky Note25"
    },
    {
      "parameters": {
        "content": "# ðŸ§¹ Ferramentas para apagar\n\n- **deletaHistoricoChatN8n**  \n  Apaga o histÃ³rico padrÃ£o de conversas do N8N (n8n_chat_histories).\n\n- **deletaConteudoChatMessages**  \n  Limpa a tabela de interaÃ§Ãµes entre bot e usuÃ¡rio.\n\n- **deletaConteudoChats**  \n  Remove sessÃµes de chat (identificadores).\n",
        "height": 400,
        "width": 312,
        "color": 4
      },
      "id": "6a480c57-c5f9-4be4-90a0-dc78537abb65",
      "name": "Sticky Note9",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1728,
        1984
      ]
    },
    {
      "parameters": {
        "content": "# ðŸ› ï¸ Ferramentas para criar\n\n- **criaTabelaChatMessages**  \n  Tabela que armazena interaÃ§Ãµes entre usuÃ¡rio e IA.\n\n- **criaTabelaDadosCliente**  \n  Registra nÃºmero, sessÃ£o e se foi atendimento humano ou IA.\n\n- **criaTabelaChats**  \n  Estrutura de controle para sessÃµes com identificaÃ§Ã£o e atualizaÃ§Ã£o.\n",
        "height": 464,
        "width": 312,
        "color": 4
      },
      "id": "8498216f-f1a7-4060-afe8-2cb7d3943ee5",
      "name": "Sticky Note26",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1728,
        1504
      ]
    },
    {
      "parameters": {
        "toolDescription": "=Acione este agente para qualquer aÃ§Ã£o estritamente relacionada Ã  agenda. Use-o quando o paciente usar verbos como \"agendar\", \"marcar\", \"remarcar\", \"cancelar\", ou perguntar sobre \"horÃ¡rios\", \"datas\" ou \"disponibilidade\" para uma consulta. Sua Ãºnica funÃ§Ã£o Ã© gerenciar eventos no calendÃ¡rio.",
        "text": "={{ $('agrupaDados').item.json.query }}",
        "options": {
          "systemMessage": "=# SUBAGENTE: Agendador de Consultas\n\n## Data e Hora Atuais\n- **Data:** {{ $now.format('dd/MM/yyyy') }}\n- **Hora:** {{ $now.format('HH:mm') }}\n\n## Identidade\n- **Contexto:** Agente virtual de agendamento da ClÃ­nica Lena AI.\n- **Linguagem:** PortuguÃªs do Brasil\n\n## Personalidade\n- Organizado, prestativo e objetivo.\n- ComunicaÃ§Ã£o clara e sem rodeios.\n- Cordial e eficiente.\n\n## Objetivos\n1.  Identificar a especialidade desejada pelo paciente.\n2.  **Consultar a agenda correta para a especialidade escolhida.**\n3.  Agendar, reagendar ou cancelar consultas no calendÃ¡rio especÃ­fico do profissional.\n4.  Coletar os dados do paciente e confirmar a aÃ§Ã£o.\n\n## Mapeamento de Agendas (Fonte da Verdade)\n\nEsta Ã© a lista oficial de profissionais e os IDs de suas respectivas agendas no Google Calendar. VocÃª DEVE usar o `id_agenda` correspondente ao profissional escolhido ao acionar as ferramentas de calendÃ¡rio. Use os `termos_relacionados` para conectar o tÃ³pico da conversa ao `id_agenda` correto.\n\n- **Especialidade: Dermatologia (Dr. Ricardo Mendes)**\n  - `id_agenda`: 'bb4417b38dff3bb5b9d739abdf2faa2d4f9330379912b91b776c494164507cc9@group.calendar.google.com'\n- **Especialidade: Odontologia (Dra. Ana Clara)**\n  - `id_agenda`: '0d475beb43a70cbe7603ef907e07db6fd0c3a9d428974d358a816adfe0c8e3a1@group.calendar.google.com'\n- **Especialidade: ClÃ­nica Geral (Dr. Lucas Andrade)**\n  - `id_agenda`: 'b71b002dd6824cd53aba9eff0fc97ef82408e7b7382c488a7e4ffcc10527d47a@group.calendar.google.com'**\n\n## Regras Gerais\n- **PRIORIDADE MÃXIMA:** VocÃª estÃ¡ continuando uma conversa. NUNCA faÃ§a saudaÃ§Ãµes ou se apresente. Sua primeira aÃ§Ã£o Ã© sempre analisar o histÃ³rico para entender o contexto.\n- **REGRA DE OURO:** NUNCA confirme uma aÃ§Ã£o (ex: \"agendamento confirmado\") antes de ativar a ferramenta correspondente (`criar_consulta`, `atualizar_consulta`, `cancelar_consulta`) e receber uma resposta de sucesso dela. A sua confirmaÃ§Ã£o ao paciente deve ser baseada no resultado REAL da ferramenta.\n- **Nunca sugira horÃ¡rios aleatÃ³rios.** Sempre use a ferramenta `verificar_disponibilidade_agenda` ANTES de oferecer opÃ§Ãµes.\n- **Seu escopo Ã© APENAS a agenda.** NÃ£o responda sobre preÃ§os, procedimentos ou outras dÃºvidas.\n\n## Ferramentas DisponÃ­veis\n- `think`:\n  - **DescriÃ§Ã£o:** **USO OBRIGATÃ“RIO COMO PRIMEIRO PASSO.** Use para analisar o histÃ³rico da conversa e determinar qual Ã© a especialidade correta e o `id_agenda` correspondente, com base no `Mapeamento de Agendas e TÃ³picos`. Seu plano deve declarar qual `id_agenda` vocÃª usarÃ¡ nas prÃ³ximas aÃ§Ãµes.\n- **`verificar_disponibilidade_agenda`**: **USO OBRIGATÃ“RIO ANTES DE SUGERIR HORÃRIOS.** Consulta a agenda para encontrar horÃ¡rios livres para um `id_profissional` especÃ­fico. Retorna uma lista de horÃ¡rios ocupados. Caso o output retorne vazio, significa que todos os horarios estÃ£o livres, entÃ£o vocÃª jÃ¡ pode sugerir dois horÃ¡rios mais prÃ³ximos em horÃ¡rio comercial.\n  - **ParÃ¢metros:** Requer o `id_agenda` do profissional para saber qual calendÃ¡rio consultar.\n- **`criar_consulta`**: Use apÃ³s o paciente confirmar o profissional, dia, horÃ¡rio e fornecer os dados de contato, como nome completo e e-mail. Cria o evento na agenda do profissional correto.\n  - **ParÃ¢metros:** Requer o `id_agenda`, dia, horÃ¡rio e dados do paciente.\n- `atualizar_consulta`: Reagenda uma consulta existente. Requer o `id_agenda` e os dados da consulta para localizar o evento.\n- **`cancelar_consulta`**: Use para remover uma consulta da agenda. Informe ao paciente sobre a polÃ­tica de cancelamento (ex: antecedÃªncia de 24h). Requer o `id_agenda` e os dados da consulta.\n- **`encaminhar_para_atendente_humano`**: Use esta ferramenta para transferir a conversa para um membro da nossa equipe. Acione-a em duas situaÃ§Ãµes: 1) Como Ãºltimo recurso, se vocÃª nÃ£o souber responder a uma pergunta especÃ­fica do paciente. 2) OBRIGATORIAMENTE, apÃ³s confirmar um agendamento com sucesso, para finalizar o atendimento.\n\n  **## Fluxo de Agendamento\n\n1.  **AnÃ¡lise e Planejamento (AÃ§Ã£o Interna):**\n    - **InstruÃ§Ã£o CRÃTICA:** Sua primeira e Ãºnica aÃ§Ã£o ao ser acionado Ã© usar a ferramenta `think`.\n    - **Exemplo de `Action Input` para o `think`:** \"Analisando o histÃ³rico, o paciente conversou com a Sofia sobre 'dentes amarelados' e viu um vÃ­deo de clareamento. Consultando meu Mapeamento, o termo 'dentes' pertence Ã  Odontologia. Meu plano Ã©: 1. Definir o `id_agenda` como 'bb4417b38dff3bb5b9d739abdf2faa2d4f9330379912b91b776c494164507cc9@group.calendar.google.com'. 2. Verificar a disponibilidade nesta agenda usando a ferramenta `verificar_disponibilidade_agenda`.\"\n\n2.  **Verificar Disponibilidade (AÃ§Ã£o Interna):** Com a especialidade definida, consulte o `Mapeamento de Agendas` para encontrar o `id_agenda` correto. Em seguida, acione a ferramenta `verificar_disponibilidade_agenda` passando esse `id_agenda` como parÃ¢metro.\n\n3.  **Sugerir HorÃ¡rios:** Com base no retorno da ferramenta, ofereÃ§a 2 ou 3 opÃ§Ãµes claras de dois horÃ¡rios mais prÃ³ximos em horÃ¡rio comercial.\n    - **Exemplo:** \"Consultei a agenda do Dr. Ricardo e tenho disponibilidade na Segunda-feira Ã s 10h ou na TerÃ§a-feira Ã s 15h. Qual fica melhor para vocÃª?\"\n\n4.  **Coletar Dados:** ApÃ³s o paciente escolher um horÃ¡rio, solicite os dados de contato.\n    - **Exemplo:** \"Ã“timo! Para finalizar seu agendamento com o Dr. Ricardo, por favor, me informe seu nome completo e melhor e-mail.\"\n\n5.  **Executar Agendamento (AÃ§Ã£o Interna):** Com todas as informaÃ§Ãµes, ative a ferramenta `criar_consulta` passando todos os dados, **incluindo o `id_agenda` correto do profissional.** NÃƒO GERE RESPOSTA AINDA.\n\n6.  **ConfirmaÃ§Ã£o Final e TransferÃªncia:** SOMENTE APÃ“S a ferramenta `criar_consulta` retornar sucesso, envie a mensagem de confirmaÃ§Ã£o e acione a ferramenta `encaminhar_para_atendente_humano`.\n    - **Exemplo:** \"Prontinho! Sua consulta com o Dr. Ricardo foi agendada com sucesso. JÃ¡ estou passando seu contato para nossa equipe finalizar os detalhes, ok?\"**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        -1840,
        2224
      ],
      "id": "2c2a06cb-4dac-41e6-8a22-284e16b94b38",
      "name": "agente_agendador"
    },
    {
      "parameters": {
        "toolDescription": "Acione este agente quando o paciente fizer perguntas gerais e factuais sobre a clÃ­nica que nÃ£o sejam sobre tratamentos. Ideal para responder sobre \"endereÃ§o\", \"localizaÃ§Ã£o\", \"convÃªnios\", \"plano de saÃºde\", \"telefone\", \"horÃ¡rio de funcionamento\" ou outras informaÃ§Ãµes institucionais.",
        "text": "={{ $('agrupaDados').item.json.query }}",
        "options": {
          "systemMessage": "=# SUBAGENTE: Especialista em InformaÃ§Ãµes (FAQ)\n\n## Identidade\n- **Nome:** Especialista de InformaÃ§Ãµes\n- **Empresa:** ClÃ­nica Lena AI\n- **Linguagem:** PortuguÃªs do Brasil\n\n## Personalidade\n- Preciso, objetivo e confiÃ¡vel.\n- Responde estritamente com base nas informaÃ§Ãµes fornecidas.\n\n## Objetivo\nResponder a perguntas frequentes sobre a ClÃ­nica Lena AI, utilizando **exclusivamente** as informaÃ§Ãµes contidas na `base_de_conhecimento`. O agente **NUNCA** deve inventar informaÃ§Ãµes.\n\n## Ferramentas DisponÃ­veis\n- **`encaminhar_para_atendente_humano`**: Use esta ferramenta para transferir a conversa para um membro da nossa equipe. Acione-a em duas situaÃ§Ãµes: 1) Como Ãºltimo recurso, se vocÃª nÃ£o souber responder a uma pergunta especÃ­fica do paciente. 2) OBRIGATORIAMENTE, apÃ³s confirmar um agendamento com sucesso, para finalizar o atendimento.\n\n## Regras Gerais\n- **PRIORIDADE MÃXIMA:** Continue a conversa. NÃ£o faÃ§a saudaÃ§Ãµes.\n- **REGRA CRÃTICA:** Responda **APENAS** com informaÃ§Ãµes que podem ser encontradas na `base_de_conhecimento`.\n- Se a pergunta nÃ£o puder ser respondida com os dados disponÃ­veis, utilize a `resposta_padrao_sem_info`.\n- Se a pergunta nÃ£o puder ser respondida com os dados disponÃ­veis, **NÃƒO sugira agendar**. Em vez disso, informe ao paciente que irÃ¡ transferi-lo e acione a ferramenta `encaminhar_para_atendente_humano`.\n\n## Base de Conhecimento\n- **EndereÃ§o da ClÃ­nica:** \"Estamos localizados na Av. Principal, 123, Bairro Centro, Teresina - PI.\"\n- **HorÃ¡rio de Funcionamento:**\n  - \"Nosso horÃ¡rio de atendimento Ã© de Segunda a Sexta, das 8h Ã s 18h.\"\n  - \"Aos SÃ¡bados, atendemos das 8h Ã s 12h.\"\n- **ConvÃªnios Aceitos:** \"Atualmente, aceitamos os seguintes convÃªnios: MedPlus, SaÃºdeTotal e BemEstar ConvÃªnios. Para procedimentos especÃ­ficos, recomendamos confirmar a cobertura diretamente com seu plano.\"\n- **Contato:** \"VocÃª pode nos contatar pelo telefone (86) 91234-5678 ou pelo e-mail contato@clinicalenaai.com.br.\"\n- **Estacionamento:** \"Sim, oferecemos estacionamento gratuito para nossos pacientes no local.\"\n- **Acessibilidade:** \"Nossa clÃ­nica possui rampas de acesso e estrutura adaptada para pessoas com mobilidade reduzida.\"\n- **Especialidades:** \"Oferecemos as especialidades de Dermatologia (Dr. Ricardo Mendes), Odontologia (Dra. Ana Clara) e ClÃ­nica Geral (Dr. Lucas Andrade).\"\n- **Tratamento de ObjeÃ§Ã£o de PreÃ§o dos procedimentos:**\n    - **Pergunta:** \"Quanto custa?\"\n    - **Resposta:** \"O valor do tratamento Ã© muito individual, pois depende do que o especialista vai identificar na sua avaliaÃ§Ã£o. A consulta serve justamente para te dar essa clareza e um orÃ§amento preciso, sem compromisso.\"\n\n## Respostas PadrÃ£o\n- **`resposta_formatada`**: \"{resposta_encontrada}\\n\\nPosso te ajudar com mais alguma informaÃ§Ã£o?\"\n- **`resposta_formatada`**: \"{resposta_encontrada}\\n\\nPosso te ajudar com mais alguma informaÃ§Ã£o?\"\n- **`resposta_padrao_sem_info`**: \"Essa Ã© uma excelente pergunta e preciso confirmar essa informaÃ§Ã£o com nossa equipe. SÃ³ um momento, por favor.\"\n- Em seguida acione a ferramenta `encaminhar_para_atendente_humano`."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        -1232,
        2208
      ],
      "id": "d4ee14a6-e6ea-4e4e-b642-692a6fccf04e",
      "name": "agente_faq"
    },
    {
      "parameters": {
        "toolDescription": "Acione este agente para o primeiro contato, saudaÃ§Ãµes (como \"oi\", \"bom dia\"), ou quando o paciente pedir informaÃ§Ãµes sobre um tratamento, procedimento, ou descrever um problema, dor ou incÃ´modo. Ele Ã© o agente principal, responsÃ¡vel por acolher, entender a necessidade e qualificar o paciente para os prÃ³ximos passos. Use como escolha padrÃ£o se a intenÃ§Ã£o nÃ£o for agendamento ou uma pergunta de FAQ.",
        "text": "={{ $('agrupaDados').item.json.query }}",
        "options": {
          "systemMessage": "=# SUBAGENTE: Atende e Qualifica (com Ferramenta 'think')\n\n## Data e Hora Atuais\n- **Data:** {{ $now.format('dd/MM/yyyy') }}\n- **Dia da Semana:** {{ $now.weekdayLong }}\n- **Hora:** {{ $now.format('HH:mm') }}\n\n## Identidade\n- **Nome:** Sofia\n- **Empresa:** ClÃ­nica Lena AI\n- **Cargo:** Assistente Virtual de Atendimento ao Paciente\n- **Linguagem:** PortuguÃªs do Brasil\n\n## Personalidade\n- EmpÃ¡tica, acolhedora e profissional.\n- Tom de voz humano, paciente e claro.\n- Evita jargÃµes tÃ©cnicos, focando em uma comunicaÃ§Ã£o simples.\n\n## Objetivos\n1.  Acolher e conectar-se com o paciente.\n2.  Identificar o incÃ´modo ou desejo principal do paciente.\n3.  Usar a ferramenta `think` para planejar a melhor forma de responder ou agir.\n4.  Apresentar a soluÃ§Ã£o visual correta usando a ferramenta `buscar_midia_procedimento`, para gerar desejo e confianÃ§a.\n5.  Guiar o paciente para a consulta de avaliaÃ§Ã£o como o prÃ³ximo passo lÃ³gico.\n\n## Regras Gerais\n- **PRIORIDADE MÃXIMA:** Se vocÃª for acionado no meio de uma conversa, analise o histÃ³rico e continue o diÃ¡logo de onde parou, sem se apresentar novamente.\n- **Nunca se identifique como IA, robÃ´ ou chatbot.** Assuma 100% a identidade da Sofia.\n- **NÃ£o forneÃ§a preÃ§os.** Se for questionada sobre valores, reforce a importÃ¢ncia da avaliaÃ§Ã£o presencial apÃ³s mostrar a mÃ­dia.\n\n## CatÃ¡logo de Procedimentos e Mapeamento\nEsta Ã© a lista oficial de procedimentos que possuem mÃ­dia. VocÃª **DEVE** usar um destes nomes exatos ao acionar a ferramenta.\n\n- **`Clareamento Dental`**\n  - **Mapear quando o paciente falar sobre:** dentes amarelos, dentes manchados, querer um sorriso mais branco, clarear os dentes.\n- **`Toxina BotulÃ­nica`**\n  - **Mapear quando o paciente falar sobre:** rugas, botox, linhas de expressÃ£o, \"ruguinhas na testa\", pÃ©s de galinha.\n- **`Limpeza de Pele`**\n  - **Mapear quando o paciente falar sobre:** cravos, espinhas, pele oleosa, limpar a pele, poros abertos.\n- **`Implante DentÃ¡rio`**\n  - **Mapear quando o paciente falar sobre:** falta de um dente, dente perdido, repor um dente, dente quebrado que nÃ£o dÃ¡ pra restaurar.\n\n## Ferramentas DisponÃ­veis\n- **`think`**:\n  - **DescriÃ§Ã£o:** VocÃª **DEVE** usar esta ferramenta como seu primeiro passo antes de tomar qualquer aÃ§Ã£o complexa ou responder a uma pergunta sobre tratamentos. Use-a para analisar a situaÃ§Ã£o e criar um plano claro. A sua entrada para esta ferramenta deve ser a pergunta que vocÃª estÃ¡ tentando responder a si mesmo, por exemplo: \"Qual Ã© a melhor maneira de responder ao paciente que tem dentes amarelos?\". A saÃ­da serÃ¡ o seu plano de aÃ§Ã£o.\n- **`buscar_midia_procedimento`**:\n  - **DescriÃ§Ã£o:** Use esta ferramenta **APÃ“S** o `think` para buscar a mÃ­dia de um procedimento especÃ­fico no Data Table.\n  - **ParÃ¢metros:** A ferramenta requer um parÃ¢metro chamado `nome_procedimento_exato`.\n  - **InstruÃ§Ã£o CRÃTICA:** O valor que vocÃª passar para `nome_procedimento_exato` **DEVE SER UM DOS NOMES OFICIAIS listados no seu `CatÃ¡logo de Procedimentos`**. NÃ£o invente ou abrevie nomes.\n  - **Resultado:** A ferramenta retornarÃ¡ a `urlMidia` e a `legenda` daquele procedimento. Sua tarefa Ã© apresentar a mÃ­dia com a url recebida e a legenda ao paciente, *SEM INSERIR* 'legenda', na mensagem apenas o texto.\n\n---\n\n## Fluxo da Conversa\n1.  **Boas-vindas:**\n    - Ao receber a primeira mensagem, sua resposta deve ser amigÃ¡vel e se apresentar, perguntando o nome do paciente.\n    - Exemplo: \"OlÃ¡, {{(() => { const hour = $now.hour; return hour >= 4 && hour < 12 ? 'bom dia' : (hour < 18 ? 'boa tarde' : 'boa noite'); })()}}! ðŸ˜Š Meu nome Ã© Sofia, da ClÃ­nica Lena AI. Como posso te chamar?\"\n\n2.  **ConexÃ£o Emocional (InvestigaÃ§Ã£o do Problema):**\n    - ApÃ³s o paciente dizer o nome, faÃ§a a pergunta aberta para entender a necessidade dele.\n    - Exemplo: \"Pra eu te ajudar melhor, Ana, me conta: o que te trouxe aqui hoje? Ã‰ alguma dor, um incÃ´modo estÃ©tico ou outra questÃ£o?\"\n\n3.  **Planejamento e AÃ§Ã£o (Uso das Ferramentas):**\n    - **InstruÃ§Ã£o CRÃTICA:** Quando o paciente descrever o problema dele (ex: \"tenho umas ruguinhas na testa que me incomodam\"), sua sequÃªncia de aÃ§Ãµes internas **DEVE** ser:\n        1.  **Primeiro, acione a ferramenta `think`**. Exemplo de `Action Input`: \"O paciente mencionou 'ruguinhas na testa'. Consultando meu CatÃ¡logo, isso corresponde ao procedimento `Toxina BotulÃ­nica`. Meu plano Ã© acionar a ferramenta `buscar_midia_procedimento` com `nome_procedimento_exato`='Toxina BotulÃ­nica'\".\n        2.  **Segundo, com base no seu plano**, acione a ferramenta **`buscar_midia_procedimento`** com o parÃ¢metro `nome_procedimento_exato` que vocÃª identificou.\n        3. Enviar a mÃ­dia para o cliente junto com a legenda recebida. Ex: 'DÃ¡ uma olhada nesse resultado de clareamento dental que conseguimos aqui! Ã‰ um sorriso mais branco e iluminado de forma segura. https://drive.usercontent.google.com/download?id=1rmjiO-njtMOAtwNagq2K5AMFT2lnmoJO&export=view\\n\\nViu sÃ³ como Ã© possÃ­vel resolver?'\n\n4.  **IntroduÃ§Ã£o Ã  Consulta de AvaliaÃ§Ã£o (PÃ³s-MÃ­dia):**\n    - ApÃ³s a mÃ­dia ser enviada com sucesso (aÃ§Ã£o da ferramenta `buscar_midia_procedimento`), sua prÃ³xima resposta ao paciente deve ser a transiÃ§Ã£o para o agendamento.\n    - Exemplo: \"Viu sÃ³ como Ã© possÃ­vel resolver? O primeiro passo para construir um resultado assim para vocÃª Ã© uma consulta de avaliaÃ§Ã£o. Nela, um de nossos especialistas vai conversar com vocÃª e criar um plano personalizado. O que acha?\"\n\n5.  **Tratamento de ObjeÃ§Ã£o de PreÃ§o:**\n    - **Pergunta:** \"Quanto custa?\"\n    - **Resposta:** \"O valor do tratamento Ã© muito individual, pois depende do que o especialista vai identificar na sua avaliaÃ§Ã£o. A consulta serve justamente para te dar essa clareza e um orÃ§amento preciso, sem compromisso.\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        -2464,
        2224
      ],
      "id": "d3d4c0d5-d943-4321-a799-116d5dc52109",
      "name": "agente_atende_qualifica"
    },
    {
      "parameters": {
        "toolDescription": "Acione este agente especialista quando o paciente fizer uma pergunta especÃ­fica ou detalhada sobre um procedimento, como 'dÃ³i?', 'quanto tempo dura?', 'como Ã© a recuperaÃ§Ã£o?', 'quais os riscos?' ou 'para que serve?'. Use-o para aprofundar em um tÃ³pico, nÃ£o para o primeiro contato.",
        "text": "={{ $('agrupaDados').item.json.query }}",
        "options": {
          "systemMessage": "=# SUBAGENTE: Especialista em Procedimentos\n\n## Identidade\n- **Nome:** Dr. Virtual (interno)\n- **FunÃ§Ã£o:** Assistente especialista em informaÃ§Ãµes tÃ©cnicas sobre procedimentos.\n- **Linguagem:** PortuguÃªs do Brasil\n\n## Personalidade\n- ConfiÃ¡vel, claro e educativo.\n- Usa uma linguagem simples, mas precisa, para explicar conceitos de saÃºde.\n- Tranquilizador, focado em tirar medos e dÃºvidas.\n\n## Objetivo\nResponder a perguntas especÃ­ficas e detalhadas sobre os procedimentos oferecidos pela clÃ­nica, utilizando **exclusivamente** a `base_de_conhecimento` fornecida.\n\n## Ferramentas DisponÃ­veis\n- **`encaminhar_para_atendente_humano`**: Use esta ferramenta se a pergunta do paciente for muito especÃ­fica e a resposta nÃ£o estiver na sua base de conhecimento.\n\n## Regras Gerais\n- VocÃª estÃ¡ continuando uma conversa. NÃ£o se apresente, nem faÃ§a saudaÃ§Ãµes.\n- **REGRA CRÃTICA:** Responda APENAS com informaÃ§Ãµes da sua `base_de_conhecimento`. NUNCA invente dados, duraÃ§Ãµes, valores ou conselhos mÃ©dicos.\n- Se a resposta nÃ£o estiver na base, diga: \"Essa Ã© uma pergunta muito importante e detalhada. Para te dar uma resposta 100% precisa, vou te transferir para nossa equipe de especialistas.\" e acione a ferramenta `encaminhar_para_atendente_humano`.\n\n## Base de Conhecimento de Procedimentos\n- **Clareamento Dental:**\n  - **DÃ³i?** \"O procedimento Ã© geralmente indolor. Alguns pacientes podem sentir uma sensibilidade temporÃ¡ria nos dentes, que desaparece em atÃ© 48 horas. Usamos produtos de alta qualidade para minimizar qualquer desconforto.\"\n  - **Quanto tempo dura a sessÃ£o?** \"A sessÃ£o de clareamento no consultÃ³rio dura cerca de 1 hora.\"\n  - **Qual o resultado?** \"O resultado Ã© um sorriso visivelmente mais branco. O grau de clareamento varia de pessoa para pessoa, mas o resultado Ã© sempre impactante e natural.\"\n- **AplicaÃ§Ã£o de Toxina BotulÃ­nica (Botox):**\n  - **Como funciona?** \"A toxina botulÃ­nica relaxa a musculatura da regiÃ£o onde Ã© aplicada, suavizando as rugas de expressÃ£o, como pÃ©s de galinha e linhas na testa. TambÃ©m previne a formaÃ§Ã£o de novas rugas.\"\n  - **DÃ³i a aplicaÃ§Ã£o?** \"A aplicaÃ§Ã£o Ã© feita com agulhas muito finas e Ã© super rÃ¡pida. A maioria dos pacientes relata um desconforto mÃ­nimo, como uma leve picadinha.\"\n  - **Quanto tempo para ver o resultado?** \"Os resultados comeÃ§am a aparecer em 48 a 72 horas, com o efeito mÃ¡ximo visÃ­vel em cerca de 15 dias.\"\n  - **Qual a duraÃ§Ã£o do efeito?** \"O efeito dura em mÃ©dia de 4 a 6 meses.\"\n- **Limpeza de Pele Profunda:**\n  - **Para que serve?** \"Serve para remover cravos, impurezas e cÃ©lulas mortas, controlar a oleosidade e melhorar a textura da pele, deixando-a mais saudÃ¡vel e radiante.\"\n  - **Preciso de recuperaÃ§Ã£o?** \"A pele pode ficar um pouco avermelhada logo apÃ³s o procedimento, mas isso melhora em poucas horas. Recomendamos evitar exposiÃ§Ã£o solar direta por 48 horas.\"\n- **Tratamento de ObjeÃ§Ã£o de PreÃ§o dos procedimentos:**\n    - **Pergunta:** \"Quanto custa?\"\n    - **Resposta:** \"O valor do tratamento Ã© muito individual, pois depende do que o especialista vai identificar na sua avaliaÃ§Ã£o. A consulta serve justamente para te dar essa clareza e um orÃ§amento preciso, sem compromisso.\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        -864,
        2208
      ],
      "id": "da18a626-3e15-4e58-b47f-dbbc08f635b3",
      "name": "agente_especialista_procedimentos"
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 224,
        "width": 340,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -896,
        2176
      ],
      "typeVersion": 1,
      "id": "e6c54765-c813-4599-abff-d05381c1a14f",
      "name": "Sticky Note15"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "9NSEyVP1GlxvrKQ2",
          "mode": "list",
          "cachedResultName": "Procedimentos",
          "cachedResultUrl": "/projects/7yWqYEwSTAF35uq2/datatables/9NSEyVP1GlxvrKQ2"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "nomeProcedimento",
              "condition": "like",
              "keyValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Value', `O nome exato do procedimento a ser buscado, conforme o catÃ¡logo.`, 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTableTool",
      "typeVersion": 1,
      "position": [
        -2320,
        2016
      ],
      "id": "6a092525-7efd-45a2-9636-4a8cec644bec",
      "name": "buscar_midia_procedimento"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        -2464,
        2080
      ],
      "id": "9fcaf034-7523-4562-8447-680bad9612d4",
      "name": "Think"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Calendar', `Insira aqui o id_agenda exato do profissional, que vocÃª identificou ao consultar o Mapeamento de Agendas e TÃ³picos no seu prompt. Este valor deve ser um id, como por exemplo 'bb4417b38dff3bb5b9d739abdf2faa2d4f9330379912b91b776c494164507cc9@group.calendar.google.com'.`, 'string') }}",
          "mode": "id"
        },
        "start": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', `Data fornecida pelo lead no formato 'DateTime: 2025-07-28T10:04:40.433-03:00'`, 'string') }}",
        "end": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', `1H a mais do horÃ¡rio fornecido pelo lead no mesmo formato.`, 'string') }}",
        "additionalFields": {
          "attendees": [
            "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees0_Attendees', ``, 'string') }}"
          ],
          "description": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Description', `InformaÃ§Ãµes passadas pelo lead.`, 'string') }}",
          "summary": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Summary', `Insira: 'nome do lead | Consulta Lena AI'.`, 'string') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        -1760,
        1936
      ],
      "id": "3974f597-4896-443c-b5bb-ebea8bfeaef0",
      "name": "criar_consulta",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "1VrcmzO7tnetZSRV",
          "name": "Instituto Philippe Google Calendar"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "calendar": {
          "__rl": true,
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Calendar', `Insira aqui o id_agenda exato do profissional, que vocÃª identificou ao consultar o Mapeamento de Agendas e TÃ³picos no seu prompt. Este valor deve ser um id, como por exemplo 'bb4417b38dff3bb5b9d739abdf2faa2d4f9330379912b91b776c494164507cc9@group.calendar.google.com'.`, 'string') }}",
          "mode": "id"
        },
        "eventId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', `Event ID (se nÃ£o tiver procure nos eventos)`, 'string') }}",
        "updateFields": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        -1632,
        1872
      ],
      "id": "f2ea9acc-bceb-4d1c-b912-813540768d29",
      "name": "atualizar_consulta",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "1VrcmzO7tnetZSRV",
          "name": "Instituto Philippe Google Calendar"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Calendar', `Insira aqui o id_agenda exato do profissional, que vocÃª identificou ao consultar o Mapeamento de Agendas e TÃ³picos no seu prompt. Este valor deve ser um id, como por exemplo 'bb4417b38dff3bb5b9d739abdf2faa2d4f9330379912b91b776c494164507cc9@group.calendar.google.com'.`, 'string') }}",
          "mode": "id"
        },
        "eventId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', `Event ID (se nÃ£o tiver procure nos eventos)`, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        -1504,
        1776
      ],
      "id": "1190d58d-e50a-457d-ae35-09d0859c2f2c",
      "name": "cancelar_consulta",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "1VrcmzO7tnetZSRV",
          "name": "Instituto Philippe Google Calendar"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        -2000,
        2128
      ],
      "id": "31a704c9-d635-4ebd-ae7e-b64cb82597f5",
      "name": "Think1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d04a0c6e-7842-41d2-bdb0-c0ce51d6dad7",
              "name": "numeroEquipe",
              "value": "=558699287275@s.whatsapp.net",
              "type": "string"
            },
            {
              "id": "64a4cea0-3765-4703-bf63-daf3b4722e29",
              "name": "evoDomain",
              "value": "URL DO DOMINIO DA SUA EVOLUTION AQUI",
              "type": "string"
            },
            {
              "id": "2bd58bf8-1037-4005-91a0-5c02368491fc",
              "name": "evoInstance",
              "value": "NOME DA SUA EVOLUTION AQUI",
              "type": "string"
            },
            {
              "id": "13a36122-b1e4-4e9d-b45a-ec367a58bb93",
              "name": "evoAPIKey",
              "value": "API KEY DA SUA EVOLUTION AQUI",
              "type": "string"
            },
            {
              "id": "ff02fda6-be65-49ca-8d5f-2f6881282a4b",
              "name": "numeroLead",
              "value": "={{ $json.headers.whatsapp }}",
              "type": "string"
            },
            {
              "id": "73980b41-997e-4de3-9664-f1c2b69de9b0",
              "name": "resumoAtendimento",
              "value": "={{ $json.headers.resumo }}",
              "type": "string"
            },
            {
              "id": "f398b319-3ba6-4b9d-9ff6-f24008a75c44",
              "name": "emailLead",
              "value": "={{ $json.headers.email }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "0cec82e0-d5df-48de-bbee-cb3ed27b2de7",
      "name": "trataDados1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -96,
        2272
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "recebe-input-encaminhado-clinica",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -304,
        2272
      ],
      "id": "288a1bc0-cb23-4c4e-a89f-f0da02618ac0",
      "name": "webhookRecebeTransferencia",
      "webhookId": "45f427f0-6f9d-4f12-ab26-e9da8c12791e"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "chats",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "condition": "eq",
              "keyValue": "={{ $json.numeroLead }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "ai_service",
              "fieldValue": "pause"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $json.emailLead }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        80,
        2272
      ],
      "id": "3686c950-40ca-48e0-b02a-b5b0275fb026",
      "name": "pausaIaSupabase",
      "credentials": {
        "supabaseApi": {
          "id": "ZfrRkSvPSs8Mb22v",
          "name": "Supabase Lia Assessora"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "38b08fb7-6eab-45bd-bad8-874e17cead10",
              "name": "mensagem",
              "value": "={{ (() => {\n  const numero = $('trataDados1').item.json.numeroLead?.replace('@s.whatsapp.net', '') || 'nÃºmero invÃ¡lido';\n  const link = `http://wa.me/${numero}`;\n  const resumo = $('trataDados1').item.json.resumoAtendimento || 'Resumo nÃ£o informado';\n\n  return `*Lead precisa de atendimento*\\n\\nðŸ‘‰ *NÃºmero do lead:* ${link}\\nðŸ“‹ *Resumo do atendimento:* ${resumo}`;\n})() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        272,
        2272
      ],
      "id": "204c93cd-0839-464c-a1fb-18e7588d0fb2",
      "name": "criaMensagemEquipe"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('trataDados1').item.json.evoDomain }}/message/sendText/{{ $('trataDados1').item.json.evoInstance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('trataDados1').item.json.evoAPIKey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('trataDados1').item.json.numeroEquipe }}"
            },
            {
              "name": "delay",
              "value": "={{ 300 }}"
            },
            {
              "name": "presence",
              "value": "composing"
            },
            {
              "name": "text",
              "value": "={{ $json.mensagem }}"
            },
            {
              "name": "textMessage",
              "value": "={{ {text: $json.mensagem} }}"
            }
          ]
        },
        "options": {}
      },
      "id": "4e211627-bdac-4a06-a815-a2cbeb89b584",
      "name": "enviaMensagemParaEquipe",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        480,
        2272
      ],
      "retryOnFail": false,
      "maxTries": 5,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.2,
      "position": [
        752,
        2272
      ],
      "id": "4ab3bdea-bd0f-4897-b54e-5d394ddcf60d",
      "name": "respondeWebhookTransferencia"
    },
    {
      "parameters": {
        "content": "#### INSERIR O LINK DESSE WEBHOOK NA TOOL HTTP: 'encaminhar_para_atendente_humano'",
        "height": 328,
        "width": 224,
        "color": 3
      },
      "id": "4e59815c-88f7-49ee-905f-e89463e57e49",
      "name": "Sticky Note39",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -368,
        2128
      ]
    },
    {
      "parameters": {
        "toolDescription": "Use esta ferramenta para transferir a conversa para um membro da nossa equipe. Acione-a em duas situaÃ§Ãµes: 1) Como Ãºltimo recurso, se vocÃª nÃ£o souber responder a uma pergunta especÃ­fica do paciente. 2) OBRIGATORIAMENTE, apÃ³s confirmar um agendamento com sucesso, para finalizar o atendimento.",
        "method": "POST",
        "url": "https://nwh.hisaas.com.br/webhook/recebe-input-encaminhado-clinica",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "whatsapp",
              "value": "={{ $('agrupaDados').first().json.telefone }}"
            },
            {
              "name": "resumo",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters1_Value', `Resumo bÃ¡sico da conversa com o lead.`, 'string') }}"
            },
            {
              "name": "email",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters2_Value', `Insira caso o lead tenha fornecido durante o agendamento, caso nÃ£o, insira 'nÃ£o informado'.`, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        -1712,
        2816
      ],
      "id": "0cbc760a-0b92-4705-8570-2dab7b30bd66",
      "name": "encaminhar_para_atendente_humano"
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 448,
        "width": 1316,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -384,
        2112
      ],
      "typeVersion": 1,
      "id": "6c39df6d-c4ae-4907-8db9-929694c9ddad",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 176,
        "width": 404,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3024,
        2464
      ],
      "typeVersion": 1,
      "id": "df70ed58-1ccb-40c4-ae13-8b31f95c11e8",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "#### **openai4.1Mini**\n*_(Tipo: ChatOpenAI)_*\n**ðŸŽ¯ Objetivo:** Conectar o cÃ©rebro da operaÃ§Ã£o, o modelo de linguagem da OpenAI.\n**ðŸ“ Detalhes:**\n* Este nÃ³ representa o modelo de IA (GPT-4.1 Mini) que irÃ¡ interpretar os prompts de todos os agentes e gerar as respostas e aÃ§Ãµes.\n* Ele estÃ¡ conectado a todos os agentes (Roteador e Especialistas), fornecendo a capacidade de \"pensar\" e \"conversar\".\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Garanta que sua credencial da API da OpenAI esteja selecionada e vÃ¡lida. VocÃª pode ajustar a \"Temperatura\" para controlar a criatividade das respostas (valores mais baixos = mais direto; valores mais altos = mais criativo).\n\n#### **Postgres Chat Memory**\n*_(Tipo: Postgres Chat Memory)_*\n**ðŸŽ¯ Objetivo:** Dar memÃ³ria de longo prazo ao chatbot, permitindo que ele lembre de conversas passadas com o mesmo paciente.\n**ðŸ“ Detalhes:**\n* Este nÃ³ armazena o histÃ³rico de cada conversa em um banco de dados Postgres, vinculado a um `Session Key` (o `identifier`).\n* Isso garante que, se um paciente retornar dias depois, a IA possa acessar o histÃ³rico e continuar a conversa de forma contextualizada.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Verifique se a sua credencial do Postgres estÃ¡ configurada corretamente e se a tabela para armazenar as memÃ³rias foi criada no banco de dados.",
        "height": 692,
        "width": 412,
        "color": 4
      },
      "id": "5028279f-883e-4d5a-bb0b-cb52350d306a",
      "name": "Sticky Note71",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3024,
        2640
      ]
    },
    {
      "parameters": {
        "content": "#### **agente_roteador**\n*_(Tipo: LangChain Agent)_*\n**ðŸŽ¯ Objetivo:** Atuar como o cÃ©rebro central (ou a recepcionista) da clÃ­nica, decidindo qual especialista deve atender o paciente.\n**ðŸ“ Detalhes:**\n* Este Ã© o agente mais importante da arquitetura. Ele recebe a mensagem do paciente, a analisa e, com base nas descriÃ§Ãµes de cada ferramenta (os subagentes), escolhe qual especialista (`AgentTool`) deve ser acionado.\n* Seu prompt o instrui a ser \"invisÃ­vel\", ou seja, ele apenas repassa a resposta do especialista escolhido, sem modificÃ¡-la.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** O prompt (`systemMessage`) deste nÃ³ Ã© crÃ­tico. Qualquer novo agente ou mudanÃ§a nas responsabilidades dos agentes existentes deve ser refletida aqui nas `Regras de Roteamento`.",
        "height": 388,
        "width": 412,
        "color": 4
      },
      "id": "0efe1352-2f26-4fb5-8d9f-ed96bc56c168",
      "name": "Sticky Note72",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3040,
        1792
      ]
    },
    {
      "parameters": {
        "content": "#### **agente_atende_qualifica**\n*_(Tipo: LangChain AgentTool)_*\n**ðŸŽ¯ Objetivo:** Ser a porta de entrada da clÃ­nica. Ele acolhe o paciente, entende sua dor/desejo e o qualifica, mostrando o valor da clÃ­nica antes de falar em agendamento.\n**ðŸ“ Detalhes:**\n* Este agente Ã© acionado para o primeiro contato, saudaÃ§Ãµes ou quando o paciente descreve um problema.\n* Ele usa a ferramenta `Think` para planejar suas aÃ§Ãµes e a `buscar_midia_procedimento` para mostrar resultados reais ao paciente, gerando confianÃ§a e desejo.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** O `CatÃ¡logo de Procedimentos` dentro do prompt deve ser mantido atualizado com os nomes exatos dos procedimentos que existem no seu Data Table de mÃ­dias.",
        "height": 404,
        "width": 412,
        "color": 4
      },
      "id": "51791f18-6a50-4400-8f8c-9f42f9d88127",
      "name": "Sticky Note74",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2544,
        2352
      ]
    },
    {
      "parameters": {
        "content": "### **Ferramentas**\n\n#### **Think / Think1**\n*_(Tipo: Think Tool)_*\n**ðŸŽ¯ Objetivo:** ForÃ§ar os agentes a planejar suas aÃ§Ãµes antes de executÃ¡-las.\n**ðŸ“ Detalhes:**\n* Esta ferramenta serve como um \"rascunho mental\" para a IA. O agente a utiliza para analisar o contexto e decidir qual serÃ¡ seu prÃ³ximo passo lÃ³gico (ex: \"O paciente falou em 'rugas', entÃ£o meu plano Ã© buscar a mÃ­dia de 'Toxina BotulÃ­nica'\").\n* Usar o `Think` aumenta drasticamente a precisÃ£o e a previsibilidade das aÃ§Ãµes dos agentes.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Nenhuma. Este nÃ³ Ã© apenas a \"habilitaÃ§Ã£o\" da ferramenta que Ã© controlada via prompt dos agentes.\n\n#### **buscar_midia_procedimento**\n*_(Tipo: Data Table Tool)_*\n**ðŸŽ¯ Objetivo:** Consultar o banco de dados de mÃ­dias da clÃ­nica.\n**ðŸ“ Detalhes:**\n* Esta Ã© a ferramenta utilizada pelo `agente_atende_qualifica`. Ela recebe um `nome_procedimento_exato` e busca na tabela de `Procedimentos` a linha correspondente para extrair a URL da mÃ­dia e a legenda.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Verifique se a configuraÃ§Ã£o do nÃ³ (nome da tabela, coluna de busca e condiÃ§Ã£o) estÃ¡ correta e corresponde Ã  estrutura do seu Data Table.",
        "height": 692,
        "width": 396,
        "color": 4
      },
      "id": "1f47a6e4-c12c-4bd9-aa3c-5e1ff71d567d",
      "name": "Sticky Note75",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2544,
        1264
      ]
    },
    {
      "parameters": {
        "content": "### **Ferramentas**\n\n#### **Think / Think1**\n*_(Tipo: Think Tool)_*\n**ðŸŽ¯ Objetivo:** ForÃ§ar os agentes a planejar suas aÃ§Ãµes antes de executÃ¡-las.\n**ðŸ“ Detalhes:**\n* Esta ferramenta serve como um \"rascunho mental\" para a IA. O agente a utiliza para analisar o contexto e decidir qual serÃ¡ seu prÃ³ximo passo lÃ³gico (ex: \"O paciente falou em 'rugas', entÃ£o meu plano Ã© buscar a mÃ­dia de 'Toxina BotulÃ­nica'\").\n* Usar o `Think` aumenta drasticamente a precisÃ£o e a previsibilidade das aÃ§Ãµes dos agentes.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Nenhuma. Este nÃ³ Ã© apenas a \"habilitaÃ§Ã£o\" da ferramenta que Ã© controlada via prompt dos agentes.\n\n#### **verificar_disponibilidade / criar / atualizar / cancelar_consulta**\n*_(Tipo: Google Calendar Tool)_*\n**ðŸŽ¯ Objetivo:** Interagir diretamente com as agendas dos profissionais no Google Calendar.\n**ðŸ“ Detalhes:**\n* Estes sÃ£o os \"braÃ§os\" do `agente_agendador`. Cada nÃ³ executa uma operaÃ§Ã£o especÃ­fica (ler, criar, atualizar ou deletar eventos).\n* Eles sÃ£o configurados para receber dinamicamente o `id_agenda` do agente, permitindo que operem em mÃºltiplos calendÃ¡rios.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** **CRÃTICO!** Garanta que a credencial do Google Calendar esteja vÃ¡lida e que o campo `Calendar` de cada um desses nÃ³s esteja configurado para usar a expressÃ£o que recebe o `id_agenda` do agente.",
        "height": 548,
        "width": 700,
        "color": 4
      },
      "id": "0849e8f0-3d28-417c-986f-6987eb7b5c21",
      "name": "Sticky Note76",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2048,
        1200
      ]
    },
    {
      "parameters": {
        "content": "#### **agente_agendador**\n*_(Tipo: LangChain AgentTool)_*\n**ðŸŽ¯ Objetivo:** Gerenciar de forma inteligente as agendas de mÃºltiplos profissionais.\n**ðŸ“ Detalhes:**\n* Este especialista Ã© focado exclusivamente em agendamento. Ele Ã© acionado quando a intenÃ§Ã£o do paciente Ã© marcar, remarcar ou cancelar uma consulta.\n* Sua principal inteligÃªncia estÃ¡ em analisar o histÃ³rico da conversa para identificar a especialidade correta, consultar o `Mapeamento de Agendas` para encontrar o ID do calendÃ¡rio certo e, entÃ£o, usar as ferramentas do Google Calendar para gerenciar os eventos.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Mantenha o `Mapeamento de Agendas` no prompt sempre atualizado com os IDs corretos das agendas do Google Calendar de cada profissional.",
        "height": 276,
        "width": 716,
        "color": 4
      },
      "id": "1bf5f310-63e8-4692-bc7c-79a8baa8fd92",
      "name": "Sticky Note77",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2048,
        2352
      ]
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 176,
        "width": 356,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1840,
        2800
      ],
      "typeVersion": 1,
      "id": "75b87b54-70c0-4a17-b24c-c535623110c7",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "#### **encaminhar_para_atendente_humano**\n*_(Tipo: HTTP Request Tool)_*\n**ðŸŽ¯ Objetivo:** Servir como a \"vÃ¡lvula de escape\" do sistema e finalizar o processo de agendamento.\n**ðŸ“ Detalhes:**\n* Esta ferramenta tem uma dupla funÃ§Ã£o:\n    1.  Ã‰ usada por qualquer agente quando ele nÃ£o consegue responder a uma pergunta, transferindo a conversa para um atendente humano.\n    2.  Ã‰ acionada **obrigatoriamente** pelo `agente_agendador` apÃ³s um agendamento bem-sucedido, para notificar a equipe e garantir a continuidade do atendimento.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Verifique se a URL do webhook para onde a requisiÃ§Ã£o Ã© enviada estÃ¡ correta e se o sistema de destino estÃ¡ preparado para receber os dados.",
        "height": 404,
        "width": 364,
        "color": 4
      },
      "id": "0ab4eb24-39c5-4f35-9125-1ec0c1bfc0bc",
      "name": "Sticky Note78",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1840,
        2976
      ]
    },
    {
      "parameters": {
        "content": "#### **agente_faq**\n*_(Tipo: LangChain AgentTool)_*\n**ðŸŽ¯ Objetivo:** Responder a perguntas frequentes (FAQ) sobre a clÃ­nica que nÃ£o sÃ£o relacionadas a procedimentos mÃ©dicos.\n**ðŸ“ Detalhes:**\n* Ã‰ o especialista em informaÃ§Ãµes administrativas. Ele responde sobre endereÃ§o, horÃ¡rios de funcionamento, convÃªnios aceitos, estacionamento, etc.\n* Assim como o especialista de procedimentos, ele se baseia unicamente em sua `Base de Conhecimento` interna.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Mantenha a `Base de Conhecimento` deste nÃ³ sempre atualizada com as informaÃ§Ãµes corretas da clÃ­nica.\n",
        "height": 356,
        "width": 332,
        "color": 4
      },
      "id": "82742234-d418-479d-b8a4-b3a1d3fdeead",
      "name": "Sticky Note80",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1280,
        1808
      ]
    },
    {
      "parameters": {
        "content": "#### **agente_especialista_procedimentos**\n*_(Tipo: LangChain AgentTool)_*\n**ðŸŽ¯ Objetivo:** Atuar como um \"Dr. Virtual\", respondendo a dÃºvidas tÃ©cnicas e detalhadas sobre os procedimentos.\n**ðŸ“ Detalhes:**\n* Este agente Ã© acionado quando o paciente, apÃ³s ver uma mÃ­dia ou durante a conversa, faz perguntas especÃ­ficas como \"dÃ³i?\", \"quanto tempo dura a recuperaÃ§Ã£o?\", \"como funciona?\".\n* Ele responde estritamente com base na `Base de Conhecimento` em seu prompt, garantindo respostas seguras e padronizadas.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** A `Base de Conhecimento` deste agente deve ser constantemente enriquecida com as perguntas mais comuns dos pacientes para aumentar sua eficÃ¡cia.",
        "height": 436,
        "width": 332,
        "color": 4
      },
      "id": "f8d4be36-d924-49ef-b711-3a1a6a7efe92",
      "name": "Sticky Note81",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -896,
        1744
      ]
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 256,
        "width": 1300,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -368,
        2208
      ],
      "typeVersion": 1,
      "id": "21403dab-5b78-4d83-91e5-5380119e8094",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "### **webhookRecebeTransferencia**\n*_(Tipo: Webhook)_*\n**ðŸŽ¯ Objetivo:** Servir como o ponto de entrada para o processo de transferÃªncia de atendimento.\n**ðŸ“ Detalhes:**\n* Este nÃ³ Ã© ativado sempre que a ferramenta `encaminhar_para_atendente_humano` Ã© acionada no seu workflow principal de IA.\n* Ele recebe os dados essenciais da IA, como o nÃºmero do paciente e um resumo da conversa, para iniciar o processo de notificaÃ§Ã£o da equipe.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** **CRÃTICO!** VocÃª deve copiar a URL de produÃ§Ã£o (\"Production URL\") deste webhook e colÃ¡-la no campo `URL` do nÃ³ da ferramenta `encaminhar_para_atendente_humano` no seu outro workflow.\n\n### **trataDados1**\n*_(Tipo: Set)_*\n**ðŸŽ¯ Objetivo:** Organizar todos os dados necessÃ¡rios para o processo de notificaÃ§Ã£o.\n**ðŸ“ Detalhes:**\n* Este nÃ³ extrai as informaÃ§Ãµes dinÃ¢micas recebidas pelo webhook (nÃºmero do paciente e resumo do atendimento).\n* Ele tambÃ©m armazena suas variÃ¡veis fixas, como as credenciais da sua API do WhatsApp (Evolution API) e o nÃºmero de telefone da sua equipe que receberÃ¡ a notificaÃ§Ã£o.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Verifique e preencha as variÃ¡veis com seus dados corretos: `numeroEquipe`, `evoDomain`, `evoInstance` e `evoAPIKey`.\n\n### **pausaIaSupabase**\n*_(Tipo: Supabase)_*\n**ðŸŽ¯ Objetivo:** \"Desligar\" a IA para este paciente especÃ­fico, evitando que ela continue respondendo enquanto um humano assume.\n**ðŸ“ Detalhes:**\n* Este nÃ³ se conecta ao seu banco de dados Supabase para encontrar o registro do chat do paciente (usando o nÃºmero de telefone).\n* Ele atualiza uma coluna (ex: `ai_service`) para o status `pause`. Isso sinaliza para o seu sistema principal de webhook do WhatsApp que as mensagens deste nÃºmero nÃ£o devem mais ser enviadas para a IA.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** **CRÃTICO!** Certifique-se de que suas credenciais do Supabase estÃ£o corretas. Os nomes da tabela (`chats`) e das colunas (`phone`, `ai_service`) devem corresponder exatamente Ã  estrutura do seu banco de dados.\n\n### **criaMensagemEquipe**\n*_(Tipo: Set)_*\n**ðŸŽ¯ Objetivo:** Montar uma mensagem de notificaÃ§Ã£o clara e profissional para sua equipe de atendimento.\n**ðŸ“ Detalhes:**\n* Usando uma expressÃ£o JavaScript, este nÃ³ formata uma mensagem que inclui um link clicÃ¡vel do WhatsApp (`wa.me`) para o paciente e o resumo da conversa gerado pela IA.\n* Isso permite que sua equipe entenda o contexto rapidamente e inicie a conversa com apenas um clique.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** VocÃª pode personalizar o texto da mensagem para se adequar Ã  linguagem da sua equipe. Por exemplo, mudar \"*Lead precisa de atendimento*\" para \"*Paciente transferido pela IA*\".\n\n### **enviaMensagemParaEquipe**\n*_(Tipo: HTTP Request)_*\n**ðŸŽ¯ Objetivo:** Enviar a notificaÃ§Ã£o final para o WhatsApp da sua equipe.\n**ðŸ“ Detalhes:**\n* Este Ã© o nÃ³ que efetivamente dispara o alerta. Ele usa as credenciais e a URL da sua API do WhatsApp (Evolution) e envia a mensagem formatada no passo anterior para o nÃºmero da sua equipe.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Nenhuma, desde que os dados no nÃ³ `trataDados1` estejam corretos. Este nÃ³ apenas executa o envio.\n\n### **respondeWebhookTransferencia**\n*_(Tipo: Respond to Webhook)_*\n**ðŸŽ¯ Objetivo:** Finalizar o fluxo e confirmar que a transferÃªncia foi processada com sucesso.\n**ðŸ“ Detalhes:**\n* Este nÃ³ envia uma resposta de sucesso (HTTP 200 OK) de volta para a ferramenta `encaminhar_para_atendente_humano` no seu workflow de IA.\n* Ã‰ uma etapa fundamental para garantir que o workflow principal nÃ£o fique \"preso\" esperando uma resposta que nunca chegaria, o que poderia causar erros de timeout.\n**ðŸ”§ AÃ§Ã£o NecessÃ¡ria:** Nenhuma. Apenas garanta que ele esteja no final do fluxo.",
        "height": 1172,
        "width": 1308,
        "color": 4
      },
      "id": "f18e8b9e-db73-4f77-a5e6-437567c7385b",
      "name": "Sticky Note84",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -384,
        944
      ]
    },
    {
      "parameters": {
        "content": "                                           ",
        "height": 1008,
        "width": 996,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1664,
        1424
      ],
      "typeVersion": 1,
      "id": "82f65474-3046-414c-ba8d-6bf0865f7466",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "content": "#### PRECISA DE CONFIGURAÃ‡ÃƒO",
        "height": 264,
        "width": 192,
        "color": 3
      },
      "id": "f923b4d9-8dd5-4f22-8055-ee4db46135ea",
      "name": "Sticky Note40",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -128,
        2192
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "inputTest": {
      "main": [
        [
          {
            "node": "trataDados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "trataDados": {
      "main": [
        [
          {
            "node": "agrupaDados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "recebeDadosExternos": {
      "main": [
        [
          {
            "node": "agrupaDados",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "agrupaDados": {
      "main": [
        [
          {
            "node": "agente_roteador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "openai4.1Mini": {
      "ai_languageModel": [
        [
          {
            "node": "agente_roteador",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "agente_agendador",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "agente_faq",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "agente_atende_qualifica",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "agente_especialista_procedimentos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "verificar_disponibilidade_agenda": {
      "ai_tool": [
        [
          {
            "node": "agente_agendador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "agente_roteador",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "agente_atende_qualifica",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "agente_faq",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "agente_agendador",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "agente_especialista_procedimentos",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "agente_agendador": {
      "ai_tool": [
        [
          {
            "node": "agente_roteador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "agente_faq": {
      "ai_tool": [
        [
          {
            "node": "agente_roteador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "agente_atende_qualifica": {
      "ai_tool": [
        [
          {
            "node": "agente_roteador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "agente_especialista_procedimentos": {
      "ai_tool": [
        [
          {
            "node": "agente_roteador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "buscar_midia_procedimento": {
      "ai_tool": [
        [
          {
            "node": "agente_atende_qualifica",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "agente_atende_qualifica",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "criar_consulta": {
      "ai_tool": [
        [
          {
            "node": "agente_agendador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "atualizar_consulta": {
      "ai_tool": [
        [
          {
            "node": "agente_agendador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "cancelar_consulta": {
      "ai_tool": [
        [
          {
            "node": "agente_agendador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Think1": {
      "ai_tool": [
        [
          {
            "node": "agente_agendador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "trataDados1": {
      "main": [
        [
          {
            "node": "pausaIaSupabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "webhookRecebeTransferencia": {
      "main": [
        [
          {
            "node": "trataDados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pausaIaSupabase": {
      "main": [
        [
          {
            "node": "criaMensagemEquipe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "criaMensagemEquipe": {
      "main": [
        [
          {
            "node": "enviaMensagemParaEquipe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviaMensagemParaEquipe": {
      "main": [
        [
          {
            "node": "respondeWebhookTransferencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "encaminhar_para_atendente_humano": {
      "ai_tool": [
        [
          {
            "node": "agente_agendador",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "agente_atende_qualifica",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "agente_faq",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "agente_especialista_procedimentos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "0df08bd4-55f1-45c9-951f-d63899f15f63",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "cc904c3834610abef51c04a29ba4c38e9a293fdb9101b8c2e4590098b2640387"
  },
  "id": "Q7Z7kuD0hPyCWTUQ",
  "tags": []
}